<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      function getChannelParam(fallback = 0) {  // 0 fallack because it's main chat channel
        return (
          new URLSearchParams(window.location.search).get("setchat") ?? fallback
        );
      }
    </script>
    <div class="full-top">
      <div class="top">
        <h1>Chat Online</h1>
        <div class="right">
          <button
            type="button"
            onclick="fullLoad();"
            style="margin-right: 50px"
          >
            Refresh Messages
          </button>
          <form id="usernameForm">
            Display Name:
            <input
              type="text"
              pattern="^[a-zA-Z0-9]{2,13}$"
              name="username"
              id="displayName"
              required
            />
            <input type="submit" value="set" />
          </form>
        </div>
      </div>
      <div class="top-menu">
        <button onclick="setchat(0);">Chat 1</button>
        <button onclick="setchat(1);">Chat 2</button>
        <button onclick="setchat(2);">Chat 3</button>
      </div>
      <script>
        async function setchat(room) {
          const params = new URLSearchParams(window.location.search);
          params.set("setchat", room);
          window.location.search = "?" + params.toString();
        }
        document.getElementById("usernameForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const input = document.getElementById("displayName");
            const params = new URLSearchParams(window.location.search);
            params.set("username", input.value.trim());

            // change this if I don't want refresh on submit v
            window.location.search = "?" + params.toString();
          });
      </script>
    </div>

    <div id="content" class="content-box">
      <ul id="messageDisplay" class="biglist"></ul>
      <script>
        async function getmessages() {
          console.log("Getting Messages...");
          room = getChannelParam();
          const list = document.getElementById("messageDisplay");
          list.innerHTML = "";
          try {
            const res = await fetch("/api/messages/" + room);
            console.log("status", res.status, "ok?", res.ok);
            const data = await res.json();
            console.log("data", data);
            if (!res.ok) throw new Error("Network error");

            //flips array so that new messages are bottom to top
            const messages = Array.isArray(data) ? data.slice().reverse() : [];

            messages.forEach((row) => {
              const li = document.createElement("li");

              li.innerHTML = `<a class="username">${row.username}:</a>
                <a class="message"> ${row.mesage}</a>
                <p class="timestamp"> ${row.timestmp}</p>
                `;
              list.appendChild(li);
            });
          } catch (err) {
            console.log(err);
          }
        }

        async function afterRender() {
          const textbox = document.getElementById("messagebox");
          textbox.value = "";
          textbox.focus();
          const container = document.querySelector(".content-box");
          const sleep = (ms) =>
            new Promise((resolve) => setTimeout(resolve, ms));
          await sleep(600);
          container.scrollTop = container.scrollHeight;
          console.log("Scrolled");
        }

        async function fullLoad() {
          getmessages();
          afterRender();
        }

        document.addEventListener("DOMContentLoaded", () => {
          fullLoad();
        });
      </script>
    </div>
    <div class="user-box">
      <form onsubmit="sendmessage(event)">
        <input
          class="text"
          placeholder="Type message here"
          type="text"
          pattern="^[a-zA-Z0-9 .,!?:;_-]{1,1500}$"
          id="messagebox"
        />
        <input class="enter" type="submit" value="send" />
        <script>
          async function sendmessage(e) {
            console.log("Sending Message...");
            const params = new URLSearchParams(window.location.search);
            const displayName = params.get("username");
            if (displayName) {
              document.getElementById("displayName").value = displayName;
            } else if (!displayName) {
              alert("Please set a username");
              console.log("No username set!");
              return;
            }

            e.preventDefault(); // stops force reload
            const msg = document.getElementById("messagebox").value.trim();
            console.log("Message:\n" + msg);
            if (!msg) {
              return;
            }

            try {
              const res = await fetch("/api/messages/" + room, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ displayName, message: msg }),
              });
              if (!res.ok) throw new Error("Failed to send");
              console.log("Getting Messages...");
              getmessages(); // refresh list after a successful insert
              afterRender();
            } catch (err) {
              console.error(err);
            }
          }
        </script>
      </form>
    </div>
  </body>
</html>
